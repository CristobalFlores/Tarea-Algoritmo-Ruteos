# Tarea-Algoritmo-Ruteos

# Plataforma
### Requisitos

Tener instalado nodejs
```
sudo apt install nodejs
```
### Pasos

Descargar y descomprimir el archivo leafletF.zip
entrar a la carpeta 

Instalar dependencias
```
npm i
```
Ejecutar
```
node app.js
```
ingresar a http://localhost:3000/


### CORRER CONTENEDOR
```
docker build -t test .
```
```
docker run -d --name test -p 5432:5432 test 
```

### CONECTARSE al docker

```
docker exec -it test /bin/bash
```

### CARGAR RUTAS

```
ogr2ogr -f "PostgreSQL" PG:"dbname=test user=test password=test host=localhost port=5432" /tmp/test.gpkg
```
### INGRESAR A DB
```
psql -U test -d test -h localhost -W
```
### AÃ±adir origen destino
```
create extension PGROUTING;
```
```
ALTER TABLE geometras_corregidas ADD COLUMN "source" integer;
ALTER TABLE geometras_corregidas ADD COLUMN "target" integer;

```

### Crear tabla geometrias

```
CREATE TABLE geometrias AS
SELECT
    ogc_fid , -- Adjust the column names based on your table schema
    camino,
    ST_LineMerge(ST_GeometryN(geom, 1)) AS geom
FROM
    geometras_corregidas;
    
select * from geometrias;
```

### Generar Network y topologia

```
SELECT pgr_nodeNetwork('geometrias', 0, 'ogc_fid', 'geom');
SELECT pgr_createTopology('geometrias_noded', 0, 'geom', 'id') AS result;
```

### Crear tabla nodo
```
CREATE TABLE node AS
 SELECT row_number() OVER (ORDER BY foo.p)::integer AS id,
 foo.p AS the_geom
 FROM (
 SELECT DISTINCT geometrias_noded.source AS p FROM geometrias_noded
 UNION
 SELECT DISTINCT geometrias_noded.target AS p FROM geometrias_noded
 ) foo
 GROUP BY foo.p;
```

### Crear tabla network
```
CREATE TABLE network AS
 SELECT a.*, b.id  as start_id, c.id as end_id
 FROM geometrias_noded AS a
 JOIN node AS b ON a.source = b.id
 JOIN node AS c ON a.target = c.id;
```

### Generar 1 ruta
```
Select cost,geom from pgr_dijkstra(
 'Select id, source, target, st_length(geom) as cost from network', 1,1540, false) as di
 JOIN network pt
 ON di.edge = pt.id ;
```

### Generar K rutas
```
Select path_id,cost,geom from pgr_KSP(
 'Select id, source, target, st_length(geom) as cost from network', 1,1540, 2, false) as di
 JOIN network pt
 ON di.edge = pt.id ;
```

### Ultimo

```
ALTER TABLE network ADD COLUMN cost DOUBLE PRECISION;

UPDATE network
    SET cost = st_length(geom) + 100 
    where old_id in (select ogc_fid as id from geometrias where camino = 'VERDE');
UPDATE network
    SET cost = st_length(geom)+ 500 
    where old_id in (select ogc_fid as id from geometrias where camino = 'AMARILLO');
UPDATE network
    SET cost = st_length(geom)+ 1000 
    where old_id in (select ogc_fid as id from geometrias where camino = 'ROJO');
select from network n ;

select * from network where old_id in (select ogc_fid as id from geometrias where camino = 'AMARILLO' or camino = 'VERDE' or camino = 'ROJO');


Select geom from pgr_dijkstra(
 'Select id, source, target, st_length(geom) as cost from network', 1,760, false) as di
 JOIN network pt
 ON di.edge = pt.id ;
Select geom from pgr_KSP(
 'Select id, source, target, cost from network', 1,760, 4, false) as di
 JOIN network pt
 ON di.edge = pt.id ;


SELECT     *
FROM pgr_dijkstra(
         'Select id, source, target, cost from network', array[1,355,12], array[1,355,12], false) as di
         JOIN network pt
         ON di.edge = pt.id ;
        


DROP TABLE IF exists tem;
CREATE TEMPORARY TABLE tem AS
SELECT     start_vid,
        end_vid,
        node,
        geom
FROM pgr_dijkstra(
         'Select id, source, target, cost from network', array[1,745,265,14,111,42], array[1,745,265,14,111,42], false) as di
         JOIN network pt
         ON di.edge = pt.id ;
   
select * from tem;

DROP TABLE IF exists merged_path;
CREATE TEMPORARY TABLE merged_path AS
select start_vid as source, end_vid as target, ST_LineMerge(ST_Collect(geom)) AS geom
FROM tem
group by start_vid, end_vid;

ALTER TABLE merged_path
ADD COLUMN id INT GENERATED BY DEFAULT AS IDENTITY  (START WITH 1 INCREMENT BY 1);

SELECT * FROM merged_path;

SELECT * FROM pgr_tsp(
    'SELECT id, source as start_vid, target as end_vid, st_length(geom) as agg_cost FROM merged_path',
    1,  -- Start node ID
    14
) ;        

```
# SCRIPT FINAL
```
CREATE EXTENSION pgrouting;   
CREATE TABLE geometrias AS
SELECT
    ogc_fid , -- Adjust the column names based on your table schema
    camino,
    name, 
    ST_LineMerge(ST_GeometryN(geom, 1)) AS geom
FROM
    geometras_corregidas;
   
select * from geometrias;
select * from geometras_corregidas gc ;
  
delete from geometrias where geom is null;
delete from geometras_corregidas where geom is null;

SELECT pgr_nodeNetwork('geometrias', 0, 'ogc_fid', 'geom');
SELECT pgr_createTopology('geometrias_noded', 0, 'geom', 'id') AS result;

CREATE TABLE node AS
 SELECT row_number() OVER (ORDER BY foo.p)::integer AS id,
 foo.p AS the_geom
 FROM (
 SELECT DISTINCT geometrias_noded.source AS p FROM geometrias_noded
 UNION
 SELECT DISTINCT geometrias_noded.target AS p FROM geometrias_noded
 ) foo
 GROUP BY foo.p;
 
CREATE TABLE network AS
 SELECT a.*, b.id  as start_id, c.id as end_id
 FROM geometrias_noded AS a
 JOIN node AS b ON a.source = b.id
 JOIN node AS c ON a.target = c.id;

ALTER TABLE network  
ADD COLUMN SAMPLE INT;

UPDATE network 
	SET SAMPLE = muestreado.sample_1 
	from muestreado 
	where network.old_id  = muestreado.ogc_fid;
 
ALTER TABLE network ADD COLUMN "cost" integer;

UPDATE network 
	SET cost = st_length(geom)*1000000 + 100000 
	where old_id in (select ogc_fid as id from geometrias where camino = 'VERDE');
UPDATE network
	SET cost = st_length(geom)*1000000 + 5000 
	where old_id in (select ogc_fid as id from geometrias where camino = 'AMARILLO');
UPDATE network
	SET cost = st_length(geom)*1000000 + 1000 
	where old_id in (select ogc_fid as id from geometrias where camino = 'ROJO');

select * from network;

Select seq,source, target, geom, agg_cost from pgr_KSP(
 'Select 	id, 
			source, 
			target, 
			st_length(geom) as cost from network', 
			1,
			989, 
			3, 
			false) as di
 JOIN network pt
 ON di.edge = pt.id ;

Select seq,source, target, geom, agg_cost from pgr_dijkstra(
 'Select 	id, 
			source, 
			target, 
			st_length(geom) as cost from network', 
			1,		-- Nodo Inicio
			989, 	-- Nodo Termino
			false) as di
 JOIN network pt
 ON di.edge = pt.id ;

	
SELECT * FROM pgr_kruskal(
  'SELECT id, source, target, cost, st_length(geom) as reverse_cost
  FROM network') as di
 JOIN network pt
 ON di.edge = pt.id ;
 
 drop table if exists tem;
CREATE TEMPORARY TABLE tem AS
SELECT     path_id as id,
        start_vid,
        end_vid,
        node,
        geom
FROM pgr_edgeDisjointPaths(
         'Select id, 
                source, 
                target, 
                cost,
                cost from network', 
        array[1,198,265,14,111,42], 
        array[1,198,265,14,111,42], 
        false) as di
         JOIN network pt
         ON di.edge = pt.id ;

select * from tem;

drop table if exists merged_path;
CREATE TEMPORARY TABLE merged_path AS
select start_vid as source, end_vid as target, ST_LineMerge(ST_Collect(geom)) AS geom
FROM tem
group by start_vid, end_vid, id;

ALTER TABLE merged_path
ADD COLUMN id INT GENERATED BY DEFAULT AS IDENTITY  (START WITH 1 INCREMENT BY 1);

SELECT * FROM merged_path;

Select * from pgr_edgeDisjointPaths(
 'Select     id, 
            source, 
            target, 
            cost,
            cost as rev_cost from network', 
            1,        -- Nodo Inicio
            989,     -- Nodo Termino
            false) as di
 JOIN network pt
 ON di.edge = pt.id ;
```

